#  9장 에지 검출과 응용



### 9.1 에지 검출

> 소벨필터와 케니 에지 검출 방법 이론과 실제 OpenCV 함수 사용 방법 알아보기



##### 9.1.1 미분과 그래디언트

- 에지(edge)는 한쪽 방향으로 픽셀 값이 급격하게 바뀌는 부분

  -  일반적으로 객체와 배경의 경계, 또는 객체와 다른 객체의 경계에서 에지가 발생
  - 영상에서 에지를 찾아내는 작업은 객체의 윤곽을 알아낼 수 있는 유용한 방법

  - 다양한 컴퓨터 비전 시스템에서 객체 판별을 위한 전처리로 에지 검출이 사용

- 수학에서 함수 또는 데이터의 변화율을 미분(derivative)이고 함

  - 함수의 미분이란 주어진 함수의 순간 변화율을 의미하며, 1차원 연속 함수 f(x)의 미분은 다음과 같이 정의

    ![image-20220315134316955](/home/kevin/.config/Typora/typora-user-images/image-20220315134316955.png) 

  - x의 변화량(Δx)이 무한히 0에 가까워질 때의 함수 값 변화량을 미분이라고 함



- 1차원 연속 함수 f(x)의 값 변화에 따른 미분 f′(x) 그래프

  ![image-20220315134256802](/home/kevin/.config/Typora/typora-user-images/image-20220315134256802.png) 

  - f(x) 값이 급격하게 바뀌는 부분을 찾기 위해서는 함수의 미분 f′(x) 값이 0보다 훨씬 크거나 또는 훨씬 작은 위치를 찾아야 함.
  - 영상으로부터 미분을 계산하려면 두 가지 특징을 고려
    - 영상이 2차원 평면에서 정의된 함수라는 점
    - 정수 단위 좌표에 픽셀이 나열되어 있는 이산함수라는 점



- 1차원 이산함수에서 미분을 구하는 방법
  - 일련의 데이터가 순서대로 나열되어 있는 경우에는 미분 근사화 방법을 이용하여 변화량을 측정할 수 있음
    - 전진 차분 ( 앞에 있는 픽셀과 픽셀 자신)
    - 후진 차분 ( 뒤에 있는 픽셀과 픽셀 자신)
    - 중앙 차분 ( 앞과 뒤 픽셀값을 이용 )
  
- 2차원 평면 편미분
  
  - 2차원 영상 I(x, y)를를 가로 방향으로 미분한다는 것은 y 좌표는 고정한 상태에서 x축 방향으로만 미분 근사를 계산하는 것을 의미하며, 이러한 연산을 x축 방향으로의 편미분(partial derivative)이라고 함
  
  - x축과 y축 방향에 대한 각각의 편미분을 중앙 차분 방법으로 근사화하면 다음과 같음
  
    ![image-20220321195540246](/home/kevin/.config/Typora/typora-user-images/image-20220321195540246.png)
  
  - 중앙 차분을 이용한 영상의 미분 근사는 마스크 연산을 이용하여 쉽게 구현할 수 있음
  
  - 2차원 영상을 x축과 y축 방향에 대해 편미분을 수행하는 단순화시킨 마스크를 주로 사용
  
    ![image-20220321195834053](/home/kevin/.config/Typora/typora-user-images/image-20220321195834053.png)



- 실제 영상에 대하여 x축 방향과 y축 방향으로 각각 편미분한 결과

  ![image-20220321200133687](/home/kevin/.config/Typora/typora-user-images/image-20220321200133687.png)



- 2차원 공간에서 정의된 함수 f(x, y)가 있을 때 이 함수의 x축 방향 미분과 y축 방향 미분을 한꺼번에 벡터로 표현한 것을 그래디언트(gradient)라고 함

  ![image-20220321202402478](/home/kevin/.config/Typora/typora-user-images/image-20220321202402478.png)



- 그라디언트 벡터 설명을 위한 예시

![image-20220321203914111](/home/kevin/.config/Typora/typora-user-images/image-20220321203914111.png)





##### 9.1.2 마스크 기반 에지 검출

> 여러 가지 방법의 미분 근사 마스크가 개발되었지만 그중 가장 널리 사용되고 있는 미분 마스크는 소벨 필터(Sobel filter) 마스크

- 3x3 소벨 필터 마스크

  ![image-20220321204516575](/home/kevin/.config/Typora/typora-user-images/image-20220321204516575.png) 

  - 대부분의 영상에는 잡음이 포함되어 있어서 1×3 또는 3×1 마스크를 이용하여 미분을 구할 경우 다소 부정확한 결과가 생성될 수 있음
  - (a)는 x축 방향으로의 편미분을 구하는 소벨 마스크이고, (b)는 y축 방향으로의 편미분을 구하는 소벨 마스크
    - (a)에 나타난 x축 방향 미분 마스크는 현재 행에 대한 중앙 차분 연산을 2회 수행하고, 이전 행과 다음 행에 대해서도 중앙 차분 연산을 1회씩 수행
    - 이러한 연산은 현재 행과 이웃 행에서의 픽셀 값 변화가 유사하다는 점을 이용하여 잡음의 영향을 줄이기 위함
    - 현재 행에서 두 번의 중앙 차분 연산을 수행하는 것은 현재 행의 중앙 차분 근사에 더 큰 가중치를 주기 위함



- OpenCV는 소벨 마스크를 이용하여 영상을 미분하는 Sobel() 함수를 제공

  ```c++
  void Sobel(InputArray src, OutputArray dst, int ddepth,
             int dx, int dy, int ksize = 3, double scale = 1, double delta = 0,
             int borderType = BORDER_DEFAULT);
  ```

  - Sobel() 함수는 3×3 소벨 마스크 또는 확장된 형태의 큰 마스크를 이용하여 영상을 미분함



- OpenCV는 널리 사용되고 있는 소벨 마스크 외에도 샤르 필터(Scharr filter) 마스크를 이용한 미분 연산도 지원함

  - 샤르 필터는 3×3 소벨 마스크보다 정확한 미분 계산을 수행하는 것으로 알려져 있음

    ```C++
    void Scharr(InputArray src, OutputArray dst, int ddepth,
                int dx, int dy, double scale = 1, double delta = 0,
                int borderType = BORDER_DEFAULT);
    ```

    

##### 캐니 에지 검출기

> 그래디언트 크기만을 기준으로 에지 픽셀을 검출하기 때문에 임계값에 민감하고 에지 픽셀이 두껍게 표현되는 문제점이 있어 캐니는 에지 검출을 최적화 문제 관점으로 접근함으로써 소벨 에지 검출 방법의 단점을 해결할 수 있는 방법을 제시함. 캐니 에지 검출기는 그래디언트의 크기와 방향을 모두 고려하여 좀 더 정확한 에지 위치 탐색 가능, 또한 에지는 서로 연결되어 있는 가능성이 높다는 점을 고려하여 그래디언트 크기가 다소 약하게 나타나는 에지도 놓치지 않고 찾을 수 있음.

- 가우시안 필터링
  - 가우시안 필터를 적용하는 이유는 영상에 포함된 잡음을 제거하기 위함
    - 다만 가우시안 필터링에 의해 영상이 부드러워지면서 에지의 세기도 함께 감소할 수 있기 때문에 적절한 표준 편차를 선택하여 가우시안 필터링을 수행해야 함
    - 영상에 포함된 잡음이 심하지 않다면 가우시안 필터링은 생략 가능

- 그래디언트 계산
  - 캐니 에지 검출기에서 그래디언트 계산은 보통 3×3 소벨 마스크를 사용
    - 다만 앞 절에서 설명한 소벨 에지 검출 방법이 오직 그래디언트 크기만을 이용하여 에지를 탐색하였다면, 캐니 에지 검출기는 좀 더 정확한 에지를 찾기 위해 그래디언트 방향도 함께 고려
    - 그러므로 가로 방향과 세로 방향으로 각각 소벨 마스크 필터링을 수행한 후, 그래디언트 크기와 방향을 모두 계산해야 함
- 비최대 억제
  - 에지 검출을 위해 단순히 그래디언트 크기가 특정 임계값보다 큰 픽셀을 선택할 경우, 에지 근방의 여러 픽셀이 한꺼번에 에지로 선택될 수 있음
  - 에지가 두껍게 표현되는 현상을 방지하기 위해 캐니 에지 검출기에서는 비최대 억제 과정을 사용
    - 결과적으로 비최대 억제를 수행함으로써 가장 변화율이 큰 위치의 픽셀만 에지로 검색
- 이중 임계값을 이용한 히스테리시스 에지 트래킹
  - 하나의 임계값을 사용할 경우 이분법으로 결과가 판단되기 때문에 환경 변화에 민감해질 수 있음
  - 보완하기 위해 캐니 에지 검출기에서는 두 개의 임계값을 사용

![image-20220322130340269](/home/kevin/.config/Typora/typora-user-images/image-20220322130340269.png)

- 캐니 에지 함수 실행 결과

  ![image-20220322133415207](/home/kevin/.config/Typora/typora-user-images/image-20220322133415207.png)

  - 임계값은 각각 100과 150으로 설정. 임계값을 낮출수록 에지로 판별되는 픽셀이 더 많아지므로 dst1 영상에 더 많은 에지 픽셀이 검출된 것을 확인할 수 있음



### 9.2 직선 검출과 원 검출

> 영상에서 추출한 에지 정보를 이용하여 영상에서 직선 또는 원을 검출하는 방법 설명.



